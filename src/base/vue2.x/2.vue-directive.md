---
lang: zh-CN
sidebarDepth: 2
meta:
  - name: description
    content: Vue2.x 全家桶相关知识点总结
  - name: keywords
    content: Vue2.x常见的自定义指令介绍
---

# 二.Vue2.x（directive）

::: tip 前言
用自定义指令可以对普通 DOM 元素进行底层操作

- bind：只调用一次，指令第一次绑定到元素时调用。在这里可以进行一次性的初始化设置
- inserted：被绑定元素插入父节点时调用 (仅保证父节点存在，但不一定已被插入文档中)
- update：所在组件的 VNode 更新时调用，但是可能发生在其子 VNode 更新之前。指令的值可能发生了改变，也可能没 有。但是你可以通过比较更新前后的值来忽略不必要的模板更新
- componentUpdated：指令所在组件的 VNode 及其子 VNode 全部更新后调用
- unbind：只调用一次，指令与元素解绑时调用

:::

## 1.n 个字符

- 1.默认使用函数形式的自定义指令和 v-model 实现此功能

  :::demo

  ```vue {6-10}
  <template>
    <el-input type="text" v-model="msg" v-split="msg" />
  </template>
  <script>
  export default {
    directives: {
      split: function (el, bindings, vnode) {
        let ctx = vnode.context // 获取当前输入框所在的上下文
        ctx[bindings.expression] = el.value.slice(0, 3) // 去当前上下文中 获取 msg 把输入的内容 截取3个放到 msg中
      },
    },
    data() {
      return { msg: "hello" }
    },
  }
  </script>
  ```

  :::

- 2.update+bind 形式的自定义指令和 v-model 实现此功能

```js
export default (Vue, options = {}) => {
  Vue.directive("split", {
    update(el, bindings, vnode) {
      let ctx = vnode.context // 获取当前输入框所在的上下文
      ctx[bindings.expression] = el.value.slice(0, 3) // 去当前上下文中 获取 msg 把输入的内容 截取3个放到 msg中
    },
    // 只当用户绑定时生效
    bind(el, bindings, vnode) {
      let ctx = vnode.context // 获取当前输入框所在的上下文
      ctx[bindings.expression] = el.value.slice(0, 3) // 去当前上下文中 获取 msg 把输入的内容 截取3个放到 msg中
    },
  })
}
```

::: demo

```vue {6-18}
<template>
  <el-input type="text" v-model="msg" v-split="msg" />
</template>
<script>
export default {
  data() {
    return { msg: "hello" }
  },
}
</script>
```

:::

- 3.去掉 v-model 只用自定义指令实现此功能

::: demo

```vue {6-18}
<template>
  <el-input type="text" v-split="msg" />
</template>
<script>
export default {
  directives: {
    split: {
      bind(el, bindings, vnode) {
        let ctx = vnode.context
        el.addEventListener("input", (e) => {
          let val = e.target.value.slice(0, 3)
          ctx[bindings.expression] = val
          el.value = val
        })
        el.value = ctx[bindings.expression].slice(0, 3)
      },
    },
  },
  data() {
    return { msg: "hello" }
  },
}
</script>
```

:::

- 4.添加 focus 自定义指令

::: demo

```vue
<template>
  <div>
    <el-button @click="flag = !flag">显示</el-button>
    <div v-if="flag">
      <el-input type="text" v-split.2="msg" v-focus />
    </div>
  </div>
</template>
<script>
export default {
  directives: {
    focus: {
      inserted(el) {
        el.focus() // 这个时机 会被bind晚一些 只有 dom渲染完后执行
      },
    },
    split: {
      bind(el, bindings, vnode) {
        let ctx = vnode.context
        el.addEventListener("input", (e) => {
          let val = e.target.value.slice(0, 3)
          ctx[bindings.expression] = val
          el.value = val
        })
        el.value = ctx[bindings.expression].slice(0, 3)
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
```

:::

## 2.防抖

::: demo

```vue
<template>
  <el-button @click="request" v-throttle>防抖按钮</el-button>
  <el-button @click="request">非防抖按钮</el-button>
</template>
<script>
export default {
  directives: {
    throttle: {
      bind: (el, binding) => {
        let throttleTime = binding.value // 防抖时间
        if (!throttleTime) {
          // 用户若不设置防抖时间，则默认2s
          throttleTime = 2000
        }
        let cbFun
        el.addEventListener(
          "click",
          (event) => {
            if (!cbFun) {
              // 第一次执行
              cbFun = setTimeout(() => {
                cbFun = null
              }, throttleTime)
            } else {
              event && event.stopImmediatePropagation()
            }
          },
          true
        )
      },
    },
  },
  methods: {
    request() {
      alert("请求成功")
    },
  },
}
</script>
```

:::

## 3.拖拽

::: demo

```vue
<template>
  <div class="content">
    <div class="box">盒子</div>
    <div class="box" style="cursor:pointer" v-drag>拖拽</div>
  </div>
</template>
<script>
export default {
  directives: {
    drag: {
      bind() {},
      inserted: function (el) {
        let flags = false
        el.ontouchstart = function (e) {
          e.preventDefault()
          flags = true
          el.style.position = "fixed"
          let touch = e.touches[0]
          let x = touch.clientX - el.offsetLeft
          let y = touch.clientY - el.offsetTop
          let screenWidth = window.screen.width
          let screenHeight = window.screen.height
          let maxX = screenWidth - el.offsetWidth
          let maxY = screenHeight - el.offsetHeight
          document.ontouchmove = function (e) {
            e.preventDefault()
            if (flags) {
              let touch = e.touches[0]
              let left = touch.clientX - x
              let top = touch.clientY - y
              if (left <= 0) {
                left = 0
              } else if (left >= maxX) {
                left = maxX
              }
              if (top <= 0) {
                top = 0
              } else if (top >= maxY) {
                top = maxY
              }
              el.style.left = left + "px"
              el.style.top = top + "px"
            }
          }
          document.ontouchend = function () {
            flags = false
          }
        }
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
<style>
.content {
  height: 200px;
}
.box {
  width: 100px;
  height: 100px;
  border: 1px solid red;
  float: left;
}
</style>
```

:::

## 4.水波纹

::: demo

```vue
<template>
  <el-button v-waves type="primary"> 水波纹效果 </el-button>
</template>
<script>
export default {
  directives: {
    waves: {
      bind(el, binding) {
        el.addEventListener(
          "click",
          (e) => {
            const customOpts = Object.assign({}, binding.value)
            const opts = Object.assign(
              {
                ele: el, // 波纹作用元素
                type: "hit", // hit点击位置扩散center中心点扩展
                color: "rgba(0, 0, 0, 0.15)", // 波纹颜色
              },
              customOpts
            )
            const target = opts.ele
            if (target) {
              target.style.position = "relative"
              target.style.overflow = "hidden"
              const rect = target.getBoundingClientRect()
              let ripple = target.querySelector(".waves-ripple")
              if (!ripple) {
                ripple = document.createElement("span")
                ripple.className = "waves-ripple"
                ripple.style.height = ripple.style.width =
                  Math.max(rect.width, rect.height) + "px"
                target.appendChild(ripple)
              } else {
                ripple.className = "waves-ripple"
              }
              switch (opts.type) {
                case "center":
                  ripple.style.top =
                    rect.height / 2 - ripple.offsetHeight / 2 + "px"
                  ripple.style.left =
                    rect.width / 2 - ripple.offsetWidth / 2 + "px"
                  break
                default:
                  ripple.style.top =
                    e.pageY -
                    rect.top -
                    ripple.offsetHeight / 2 -
                    document.body.scrollTop +
                    "px"
                  ripple.style.left =
                    e.pageX -
                    rect.left -
                    ripple.offsetWidth / 2 -
                    document.body.scrollLeft +
                    "px"
              }
              ripple.style.backgroundColor = opts.color
              ripple.className = "waves-ripple z-active"
              return false
            }
          },
          false
        )
      },
    },
  },
  methods: {
    request() {
      alert("请求成功")
    },
  },
}
</script>
<style>
.waves-ripple {
  position: absolute;
  border-radius: 100%;
  background-color: rgba(0, 0, 0, 0.15);
  background-clip: padding-box;
  pointer-events: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-transform: scale(0);
  -ms-transform: scale(0);
  transform: scale(0);
  opacity: 1;
}

.waves-ripple.z-active {
  opacity: 0;
  -webkit-transform: scale(2);
  -ms-transform: scale(2);
  transform: scale(2);
  -webkit-transition: opacity 1.2s ease-out, -webkit-transform 0.6s ease-out;
  transition: opacity 1.2s ease-out, -webkit-transform 0.6s ease-out;
  transition: opacity 1.2s ease-out, transform 0.6s ease-out;
  transition: opacity 1.2s ease-out, transform 0.6s ease-out,
    -webkit-transform 0.6s ease-out;
}
</style>
```

:::

## 5.权限按钮

::: demo

```vue
<template>
  <div class="btns">
    <button v-perm="'1'">权限按钮1</button>
    <button v-perm="'10'">权限按钮2</button>
  </div>
</template>
<script>
export default {
  directives: {
    perm: {
      inserted: function (el, binding) {
        function checkArray(key) {
          let arr = ["1", "2", "3", "4"]
          let index = arr.indexOf(key)
          if (index > -1) {
            return true // 有权限
          } else {
            return false // 无权限
          }
        }
        let permission = binding.value // 获取到 v-permission的值
        if (permission) {
          let hasPermission = checkArray(permission)
          if (!hasPermission) {
            // 没有权限 移除Dom元素
            el.parentNode && el.parentNode.removeChild(el)
          }
        }
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
```

:::

## 6.空白点击

::: details 查看详情
<<< @/src/directive/split.js
:::

## 7.滚动加载

::: details 查看详情
<<< @/src/directive/split.js
:::

## 8.懒加载

::: demo

```vue
<template>
  <img v-Lazy="xxx.jpg" />
</template>
<script>
export default {
  directives: {
    Lazy: {
      // install方法
      install(Vue, options) {
        const defaultSrc = options.default
        Vue.directive("lazy", {
          bind(el, binding) {
            LazyLoad.init(el, binding.value, defaultSrc)
          },
          inserted(el) {
            if (IntersectionObserver) {
              LazyLoad.observe(el)
            } else {
              LazyLoad.listenerScroll(el)
            }
          },
        })
      },
      // 初始化
      init(el, val, def) {
        el.setAttribute("data-src", val)
        el.setAttribute("src", def)
      },
      // 利用IntersectionObserver监听el
      observe(el) {
        var io = new IntersectionObserver((entries) => {
          const realSrc = el.dataset.src
          if (entries[0].isIntersecting) {
            if (realSrc) {
              el.src = realSrc
              el.removeAttribute("data-src")
            }
          }
        })
        io.observe(el)
      },
      // 监听scroll事件
      listenerScroll(el) {
        const handler = LazyLoad.throttle(LazyLoad.load, 300)
        LazyLoad.load(el)
        window.addEventListener("scroll", () => {
          handler(el)
        })
      },
      // 加载真实图片
      load(el) {
        const windowHeight = document.documentElement.clientHeight
        const elTop = el.getBoundingClientRect().top
        const elBtm = el.getBoundingClientRect().bottom
        const realSrc = el.dataset.src
        if (elTop - windowHeight < 0 && elBtm > 0) {
          if (realSrc) {
            el.src = realSrc
            el.removeAttribute("data-src")
          }
        }
      },
      // 节流
      throttle(fn, delay) {
        let timer
        let prevTime
        return function (...args) {
          const currTime = Date.now()
          const context = this
          if (!prevTime) prevTime = currTime
          clearTimeout(timer)

          if (currTime - prevTime > delay) {
            prevTime = currTime
            fn.apply(context, args)
            clearTimeout(timer)
            return
          }

          timer = setTimeout(function () {
            prevTime = Date.now()
            timer = null
            fn.apply(context, args)
          }, delay)
        }
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
```

:::

## 9.复制

::: demo

```vue
<template>
  <div>
    <div v-copy>单击复制：故人西辞黄鹤楼</div>
    <div v-copy.dblclick>双击复制：烟花三月下扬州</div>
    <div v-copy.icon>icon复制：孤帆远影碧空尽，唯见长江天际流。</div>
  </div>
</template>
<script>
export default {
  directives: {
    copy: {
      bind(el, binding) {
        function handleClick(text) {
          // 创建元素
          if (!document.getElementById("copyTarget")) {
            const copyTarget = document.createElement("input")
            copyTarget.setAttribute(
              "style",
              "position:fixed;top:0;left:0;opacity:0;z-index:-1000;"
            )
            copyTarget.setAttribute("id", "copyTarget")
            document.body.appendChild(copyTarget)
          }

          // 复制内容
          const input = document.getElementById("copyTarget")
          input.value = text
          input.select()
          document.execCommand("copy")
        }

        // 双击触发复制
        if (binding.modifiers.dblclick) {
          el.addEventListener("dblclick", () => handleClick(el.innerText))
          el.style.cursor = "copy"
        }
        // 点击icon触发复制
        else if (binding.modifiers.icon) {
          if (el.hasIcon) return
          const iconElement = document.createElement("i")
          iconElement.setAttribute("class", "el-icon-document-copy")
          iconElement.setAttribute("style", "margin-left:5px")
          el.appendChild(iconElement)
          el.hasIcon = true
          iconElement.addEventListener("click", () => handleClick(el.innerText))
          iconElement.style.cursor = "copy"
        }
        // 单击触发复制
        else {
          el.addEventListener("click", () => handleClick(el.innerText))
          el.style.cursor = "copy"
        }
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
```

:::

## 10.全屏

:::

```vue
<template>
  <div v-screen.icon>全屏</div>
</template>
<script>
export default {}
</script>
```

:::

## 11.回到顶部

::: demo

```vue
<template>
  <div v-backtop:app="400">回到顶部</div>
  <div v-backtop>回到顶部</div>
</template>
<script>
export default {
  directives: {
    backtop: {
      bind(el, binding, vnode) {
        // 响应点击后滚动到元素顶部
        el.addEventListener("click", () => {
          const target = binding.arg
            ? document.getElementById(binding.arg)
            : window
          target.scrollTo({
            top: 0,
            behavior: "smooth",
          })
        })
      },
      update(el, binding, vnode) {
        // 滚动到达参数值才出现绑定指令的元素
        const target = binding.arg
          ? document.getElementById(binding.arg)
          : window
        if (binding.value) {
          target.addEventListener("scroll", (e) => {
            if (e.srcElement.scrollTop > binding.value) {
              el.style.visibility = "unset"
            } else {
              el.style.visibility = "hidden"
            }
          })
        }
        // 判断初始化状态
        if (target.scrollTop < binding.value) {
          el.style.visibility = "hidden"
        }
      },
      unbind(el) {
        const target = binding.arg
          ? document.getElementById(binding.arg)
          : window
        target.removeEventListener("scroll")
        el.removeEventListener("click")
      },
    },
  },
}
</script>
```

:::

## 12.文字省略

::: demo

```vue
<template>
  <div v-ellipsis:100>
    君不见，黄河之水天上来，奔流到海不复回。
    君不见，高堂明镜悲白发，朝如青丝暮成雪。 人生得意须尽欢，莫使金樽空对月。
    天生我材必有用，千金散尽还复来。 烹羊宰牛且为乐，会须一饮三百杯。
    岑夫子，丹丘生，将进酒，杯莫停。 与君歌一曲，请君为我倾耳听。
    钟鼓馔玉不足贵，但愿长醉不愿醒。 古来圣贤皆寂寞，惟有饮者留其名。
    陈王昔时宴平乐，斗酒十千恣欢谑。 主人何为言少钱，径须沽取对君酌。
    五花马，千金裘，呼儿将出换美酒，与尔同销万古愁。
  </div>
</template>
<script>
export default {
  directives: {
    ellipsis: function (el, binding) {
      el.style.width = binding.arg || 100 + "px"
      el.style.whiteSpace = "nowrap"
      el.style.overflow = "hidden"
      el.style.textOverflow = "ellipsis"
    },
  },
}
</script>
```

:::

## 13.水印

::: demo

```vue
<template>
  <div
    v-waterMarker="{ text: '版权所有', textColor: 'rgba(180, 180, 180, 0.4)' }"
  ></div>
</template>
<script>
export default {
  directives: {
    waterMarker: {
      bind: function (el, binding) {
        function addWaterMarker(str, parentNode, font, textColor) {
          // 水印文字，父元素，字体，文字颜色
          var can = document.createElement("canvas")
          parentNode.appendChild(can)
          can.width = 200
          can.height = 150
          can.style.display = "none"
          var cans = can.getContext("2d")
          cans.rotate((-20 * Math.PI) / 180)
          cans.font = font || "16px Microsoft JhengHei"
          cans.fillStyle = textColor || "rgba(180, 180, 180, 0.3)"
          cans.textAlign = "left"
          cans.textBaseline = "Middle"
          cans.fillText(str, can.width / 10, can.height / 2)
          parentNode.style.backgroundImage =
            "url(" + can.toDataURL("image/png") + ")"
        }
        addWaterMarker(
          binding.value.text,
          el,
          binding.value.font,
          binding.value.textColor
        )
      },
    },
  },
}
</script>
```

:::
