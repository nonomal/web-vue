---
lang: zh-CN
sidebarDepth: 2
meta:
  - name: description
    content: Vue2.x 全家桶相关知识点总结
  - name: keywords
    content: Vue2.x常见的自定义指令介绍
---

# 二.Vue2.x（directive）

::: tip 前言
用自定义指令可以对普通 DOM 元素进行底层操作

- bind：只调用一次，指令第一次绑定到元素时调用。在这里可以进行一次性的初始化设置
- inserted：被绑定元素插入父节点时调用 (仅保证父节点存在，但不一定已被插入文档中)
- update：所在组件的 VNode 更新时调用，但是可能发生在其子 VNode 更新之前。指令的值可能发生了改变，也可能没 有。但是你可以通过比较更新前后的值来忽略不必要的模板更新
- componentUpdated：指令所在组件的 VNode 及其子 VNode 全部更新后调用
- unbind：只调用一次，指令与元素解绑时调用

:::

## 1.n 个字符

- 1.默认使用函数形式的自定义指令和 v-model 实现此功能

  :::demo

  ```vue {6-10}
  <template>
    <el-input type="text" v-model="msg" v-split="msg" />
  </template>
  <script>
  export default {
    directives: {
      split: function (el, bindings, vnode) {
        let ctx = vnode.context // 获取当前输入框所在的上下文
        ctx[bindings.expression] = el.value.slice(0, 3) // 去当前上下文中 获取 msg 把输入的内容 截取3个放到 msg中
      },
    },
    data() {
      return { msg: "hello" }
    },
  }
  </script>
  ```

  :::

- 2.update+bind 形式的自定义指令和 v-model 实现此功能

```js
export default (Vue, options = {}) => {
  Vue.directive("split", {
    update(el, bindings, vnode) {
      let ctx = vnode.context // 获取当前输入框所在的上下文
      ctx[bindings.expression] = el.value.slice(0, 3) // 去当前上下文中 获取 msg 把输入的内容 截取3个放到 msg中
    },
    // 只当用户绑定时生效
    bind(el, bindings, vnode) {
      let ctx = vnode.context // 获取当前输入框所在的上下文
      ctx[bindings.expression] = el.value.slice(0, 3) // 去当前上下文中 获取 msg 把输入的内容 截取3个放到 msg中
    },
  })
}
```

::: demo

```vue {6-18}
<template>
  <el-input type="text" v-model="msg" v-split="msg" />
</template>
<script>
export default {
  data() {
    return { msg: "hello" }
  },
}
</script>
```

:::

- 3.去掉 v-model 只用自定义指令实现此功能

::: demo

```vue {6-18}
<template>
  <el-input type="text" v-split="msg" />
</template>
<script>
export default {
  directives: {
    split: {
      bind(el, bindings, vnode) {
        let ctx = vnode.context
        el.addEventListener("input", (e) => {
          let val = e.target.value.slice(0, 3)
          ctx[bindings.expression] = val
          el.value = val
        })
        el.value = ctx[bindings.expression].slice(0, 3)
      },
    },
  },
  data() {
    return { msg: "hello" }
  },
}
</script>
```

:::

- 4.添加 focus 自定义指令

::: demo

```vue
<template>
  <div>
    <el-button @click="flag = !flag">显示</el-button>
    <div v-if="flag">
      <el-input type="text" v-split.2="msg" v-focus />
    </div>
  </div>
</template>
<script>
export default {
  directives: {
    focus: {
      inserted(el) {
        el.focus() // 这个时机 会被bind晚一些 只有 dom渲染完后执行
      },
    },
    split: {
      bind(el, bindings, vnode) {
        let ctx = vnode.context
        el.addEventListener("input", (e) => {
          let val = e.target.value.slice(0, 3)
          ctx[bindings.expression] = val
          el.value = val
        })
        el.value = ctx[bindings.expression].slice(0, 3)
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
```

:::

## 2.防抖

::: demo

```vue
<template>
  <el-button @click="request" v-throttle>防抖按钮</el-button>
  <el-button @click="request">非防抖按钮</el-button>
</template>
<script>
export default {
  directives: {
    throttle: {
      bind: (el, binding) => {
        let throttleTime = binding.value // 防抖时间
        if (!throttleTime) {
          // 用户若不设置防抖时间，则默认2s
          throttleTime = 2000
        }
        let cbFun
        el.addEventListener(
          "click",
          (event) => {
            if (!cbFun) {
              // 第一次执行
              cbFun = setTimeout(() => {
                cbFun = null
              }, throttleTime)
            } else {
              event && event.stopImmediatePropagation()
            }
          },
          true
        )
      },
    },
  },
  methods: {
    request() {
      alert("请求成功")
    },
  },
}
</script>
```

:::

## 3.拖拽

::: demo

```vue
<template>
  <div class="content">
    <div class="box">盒子</div>
    <div class="box" style="cursor:pointer" v-drag>拖拽</div>
  </div>
</template>
<script>
export default {
  directives: {
    drag: {
      bind() {},
      inserted: function (el) {
        let flags = false
        el.ontouchstart = function (e) {
          e.preventDefault()
          flags = true
          el.style.position = "fixed"
          let touch = e.touches[0]
          let x = touch.clientX - el.offsetLeft
          let y = touch.clientY - el.offsetTop
          let screenWidth = window.screen.width
          let screenHeight = window.screen.height
          let maxX = screenWidth - el.offsetWidth
          let maxY = screenHeight - el.offsetHeight
          document.ontouchmove = function (e) {
            e.preventDefault()
            if (flags) {
              let touch = e.touches[0]
              let left = touch.clientX - x
              let top = touch.clientY - y
              if (left <= 0) {
                left = 0
              } else if (left >= maxX) {
                left = maxX
              }
              if (top <= 0) {
                top = 0
              } else if (top >= maxY) {
                top = maxY
              }
              el.style.left = left + "px"
              el.style.top = top + "px"
            }
          }
          document.ontouchend = function () {
            flags = false
          }
        }
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
<style>
.content {
  height: 200px;
}
.box {
  width: 200px;
  height: 200px;
  border: 1px solid red;
  float: left;
}
</style>
```

:::

## 4.水波纹

::: demo

```vue
<template>
  <el-button v-waves type="primary"> 水波纹效果 </el-button>
</template>
<script>
export default {
  directives: {
    waves: {
      bind(el, binding) {
        el.addEventListener(
          "click",
          (e) => {
            const customOpts = Object.assign({}, binding.value)
            const opts = Object.assign(
              {
                ele: el, // 波纹作用元素
                type: "hit", // hit点击位置扩散center中心点扩展
                color: "rgba(0, 0, 0, 0.15)", // 波纹颜色
              },
              customOpts
            )
            const target = opts.ele
            if (target) {
              target.style.position = "relative"
              target.style.overflow = "hidden"
              const rect = target.getBoundingClientRect()
              let ripple = target.querySelector(".waves-ripple")
              if (!ripple) {
                ripple = document.createElement("span")
                ripple.className = "waves-ripple"
                ripple.style.height = ripple.style.width =
                  Math.max(rect.width, rect.height) + "px"
                target.appendChild(ripple)
              } else {
                ripple.className = "waves-ripple"
              }
              switch (opts.type) {
                case "center":
                  ripple.style.top =
                    rect.height / 2 - ripple.offsetHeight / 2 + "px"
                  ripple.style.left =
                    rect.width / 2 - ripple.offsetWidth / 2 + "px"
                  break
                default:
                  ripple.style.top =
                    e.pageY -
                    rect.top -
                    ripple.offsetHeight / 2 -
                    document.body.scrollTop +
                    "px"
                  ripple.style.left =
                    e.pageX -
                    rect.left -
                    ripple.offsetWidth / 2 -
                    document.body.scrollLeft +
                    "px"
              }
              ripple.style.backgroundColor = opts.color
              ripple.className = "waves-ripple z-active"
              return false
            }
          },
          false
        )
      },
    },
  },
  methods: {
    request() {
      alert("请求成功")
    },
  },
}
</script>
<style>
.waves-ripple {
  position: absolute;
  border-radius: 100%;
  background-color: rgba(0, 0, 0, 0.15);
  background-clip: padding-box;
  pointer-events: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
  -webkit-transform: scale(0);
  -ms-transform: scale(0);
  transform: scale(0);
  opacity: 1;
}

.waves-ripple.z-active {
  opacity: 0;
  -webkit-transform: scale(2);
  -ms-transform: scale(2);
  transform: scale(2);
  -webkit-transition: opacity 1.2s ease-out, -webkit-transform 0.6s ease-out;
  transition: opacity 1.2s ease-out, -webkit-transform 0.6s ease-out;
  transition: opacity 1.2s ease-out, transform 0.6s ease-out;
  transition: opacity 1.2s ease-out, transform 0.6s ease-out,
    -webkit-transform 0.6s ease-out;
}
</style>
```

:::

## 5.权限

::: demo

```vue
<template>
  <div class="btns">
    <button v-perm="'1'">权限按钮1</button>
    <button v-perm="'10'">权限按钮2</button>
  </div>
</template>
<script>
export default {
  directives: {
    perm: {
      inserted: function (el, binding) {
        function checkArray(key) {
          let arr = ["1", "2", "3", "4"]
          let index = arr.indexOf(key)
          if (index > -1) {
            return true // 有权限
          } else {
            return false // 无权限
          }
        }
        let permission = binding.value // 获取到 v-permission的值
        if (permission) {
          let hasPermission = checkArray(permission)
          if (!hasPermission) {
            // 没有权限 移除Dom元素
            el.parentNode && el.parentNode.removeChild(el)
          }
        }
      },
    },
  },
  data() {
    return { flag: false, msg: "hello" }
  },
}
</script>
```

:::

## 6.空白点击

::: details 查看详情
<<< @/src/directive/split.js
:::

## 7.滚动加载

::: details 查看详情
<<< @/src/directive/split.js
:::

## 8.懒加载

::: demo

```vue
<img v-LazyLoad="xxx.jpg" />
```

:::

## 9.复制

::: demo

```vue
<template>
  <div v-copy>单击复制</div>
  <div v-copy.dblclick>双击复制</div>
  <div v-copy.icon>icon复制</div>
</template>
```

:::

## 10.全屏

:::

```vue
<template>
  <div v-screen.icon>全屏</div>
</template>
```

:::

## 11.回到顶部

::: demo

```vue
<template>
  <div v-backtop:app="400">回到顶部</div>
  <div v-backtop>回到顶部</div>
</template>
```

:::

## 12.文字省略

::: demo

```vue
<template>
  <div v-ellipsis:100>
    需要省略的文字是阿萨的副本阿萨的副本阿萨的副本阿萨的副本
  </div>
</template>
```

:::

## 13.水印

:::

```vue
<template>
  <div
    v-waterMarker="{ text: '版权所有', textColor: 'rgba(180, 180, 180, 0.4)' }"
  ></div>
</template>
```

:::
